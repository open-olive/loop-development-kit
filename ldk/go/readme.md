# Loop Development Kit (LDK) for Go

The LDK is a plugin system for Olive Helps. The LDK is built with [go-plugin](https://github.com/hashicorp/go-plugin), a HashiCorp plugin system used in several of their projects.

Plugins ("loops") developed with this library are executed by Olive Helps as separate processes. This ensures that crashes or instability in the plugin will not destabilize the Olive Helps process.

Communication between Olive Helps and the plugin is first initialized over stdio and then performed using [GRPC](https://grpc.io/). On mac and linux the GRPC communication is sent over unix domain socket and on windows over local TCP socket.

In order for Olive Helps to use a plugin, it must be compiled. Olive Helps does not compile or interpret source code at runtime. A consequence of this is that plugins will need to be compiled for each operating system that they want to support.

## Installation

```shell
go get -u github.com/open-olive/loop-development-kit/ldk/go
```

## Usage

Full documentation available on [pkg.go.dev](https://pkg.go.dev/github.com/open-olive/loop-development-kit/ldk/go).

### Loops
This LDK can be used to write loops for Olive Helps. More detail about loops is available [here](docs/loops.md).

Example loops are available in the examples folder.

## Development

### protoc
The LDK utilizes `protoc` to create the `protobuf` that defines the contract that is utilized by GRPC.

* Install protobuf with Homebrew `brew link protobuf`
* Make your changes to `proto/ldk.proto`
* Then generate the new protobuf file with `make proto/ldk.pb.go`

Since `proto/ldk.pb.go` is auto-generated, do not edit this file directly.

### Running Locally

#### Local Plugin Command (Recommended)

Olive Helps lets you add a local command as Local Plugins:

1. Open Olive Helps.
2. Open the Loop Library:
    1. Click the hamburger icon.
    2. Click Loop Library.
3. Click the Install Local Plugin button (in the upper right).
4. Select whether it's a Controller or Sensor.
5. Select the working directory for the command.
6. Enter the command to be executed, including any arguments.
7. Click Install.

The command will be installed as a plugin. If you need to change the command or its arguments you'll need remove it and then add the new commands. If you are developing locally, it can be helpful to give it the `go run` command, as this will remove the need to recompile each time to check your changes:

```sh
go run main.go
```

Be sure that when you selected the working directory in `Step 5` that it is the root of your project that has the `main.go` file located in it.

### Troubleshooting and Debugging

Olive Helps logs are available in the following directories for your OS:

```shell
~/Library/Logs/Olive\ Helps   # MacOS
/var/log/Olive\ Helps         # Linux
%AppData%\Olive Helps\Logs\   # Windows
```

#### Tailing Logs

It can be useful to tail the log as you develop to see any errors, warnings, or info messages.  To do so, you can issue any of the following commands:

##### Linux

```sh
tail -F /var/log/Olive\ Helps/*.log
```

##### Mac

```sh
tail -F ~/Library/Logs/Olive\ Helps/*.log
```

##### Windows

From `Powershell` (not a cmd shell):

```powershell
Get-Content $env:AppData\Olive Helps\Logs\Olive Helps-2020.08.12-1dcc37a.log -Tail 10 â€“Wait
```

Note: File names may differ from the examples above.

### Configuration

#### `storage.json`

Each storage key you access must be specified in the `storage.json` file.

```json
{
  "storage-key": {
    "name": "Storage Key Name",
    "description": "What you're containing in this key"
  },
  "storage-key2": {
    "name": "Storage Key 2",
    "description": "What you're containing in this key"
  }
}
```
